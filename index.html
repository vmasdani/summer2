<html>
  <head>
    <meta charset="UTF-8" />
    <title>Main</title>
    <link rel="stylesheet" href="css/tailwind.css" />
    <link rel="icon" href="static/gear.png" />
    <script src="https://cdn.jsdelivr.net/npm/idb-keyval@5/dist/iife/index-min.js"></script>
    <script src="js/main.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>

  <body>
    <div id="myapp"></div>
    <script>
      var app = Elm.Main.init({
        node: document.getElementById("myapp"),
        flags: {
          seed: Math.floor(
            (new Date().getTime() / 1000 + Math.random()) * 1000
          ),
        },
      });

      app.ports.idbSend.subscribe(async (obj) => {
        console.log(obj);
        console.log(obj.table);

        const item = JSON.parse(obj.content);

        const items = await idbKeyval.get(obj.table);

        if (items) {
          await idbKeyval.set(obj.table, [...items, item]);

          app.ports.idbRecv.send({
            table: obj.table,
            content: JSON.stringify(await idbKeyval.get(obj.table)),
          });
        }
      });

      const initApp = async () => {
        await Promise.all(
          ["boms", "bomItems"].map(async (table) => {
            console.log("Table:", await idbKeyval.get(table));

            if (!(await idbKeyval.get(table))) {
              await idbKeyval.set(table, []);
            }

            app.ports.idbRecv.send({
              table: table,
              content: JSON.stringify(await idbKeyval.get(table)),
            });
          })
        );
      };

      initApp();
    </script>
  </body>
</html>
