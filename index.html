<html>

<head>
  <meta charset="UTF-8" />
  <title>Main</title>
  <link rel="stylesheet" href="css/tailwind.css" />
  <link rel="icon" href="static/gear.png" />
  <script src="js/idb-keyval.min.js"></script>
  <script src="js/main.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>

<body>
  <div id="myapp"></div>
  <script>
    var app = Elm.Main.init({
      node: document.getElementById("myapp"),
      flags: {
        seed: Math.floor(
          (new Date().getTime() / 1000 + Math.random()) * 1000
        ),
      },
    });

    app.ports.idbSend.subscribe(async (obj) => {
      console.log(obj);
      console.log(obj.table);

      const items = JSON.parse(obj.content);

      // console.log('Recv items:', items)

      if (items) {
        await idbKeyval.set(obj.table, items);

        app.ports.idbRecv.send({
          table: obj.table,
          content: JSON.stringify(await idbKeyval.get(obj.table)),
        });
      }
    });

    const initApp = async () => {
      await Promise.all(
        ["boms", "bomItems"].map(async (table) => {
          console.log("Table:", await idbKeyval.get(table));

          if (!(await idbKeyval.get(table))) {
            await idbKeyval.set(table, []);
          }

          app.ports.idbRecv.send({
            table: table,
            content: JSON.stringify(await idbKeyval.get(table)),
          });
        })
      );
    };

    initApp();
  </script>
</body>

</html>