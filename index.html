<!DOCTYPE html>
<html>

<head>
  <title>My IDB + Alpine test</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="./css/tailwind.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/idb-keyval@5/dist/iife/index-min.js"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

</head>

<body>
  <!-- Init script for idb -->
  <script>
    const state = {
      showList: true,
      selectedBom: null
    }

    document.addEventListener('alpine:init', () => {
      Alpine.store('idb', {
      })
    })

    const init = async (store) => {
      console.log('alpine store:', store)

      const dbs = [
        'boms',
        'items'
      ]

      await Promise.all(dbs.map(async db => {
        // Initial population
        const table = await (idbKeyval.get(db))

        if (table) {
          console.log(db, 'found', table)

          store.idb[db] = table
        } else {
          const tableSetupRes = await idbKeyval.set(db, [])

          console.log(db, 'setup res:', tableSetupRes)
        }
      }))

      console.log('Population success')
    }

    const addBom = async (store) => {
      console.log(store.idb.boms)

      store.idb.boms.push({
        id: `${new Date().getTime()}${Math.random()}`,
        name: ``,
        createdAt: new Date().getTime()
      })

      await idbKeyval.set('boms', JSON.parse(JSON.stringify(store.idb.boms)))
    }

    const setBomName = async (store, bomUuid, bomName) => {
      if (store.idb.boms) {
        store.idb.boms = store.idb.boms.map(bom => bom.id === bomUuid ? { ...bom, name: bomName } : bom)
        await idbKeyval.set('boms', JSON.parse(JSON.stringify(store.idb.boms)))
      }
    }

    // const handleSelectBom = (selectedBom, bom) => {
    //   console.log(selectedBom, bom)
    //   selectedBom = bom
    // }

    const handleDeleteBom = (store, bomUuid) => {
      const confirmation = confirm(`Really delete BOM?`)
    }
  </script>

  <div class="container mx-auto p-3" x-data="state" x-init="() => { init($store) }">
    <div class="flex justify-center m-3">
      <div class="p-3 border-2 rounded-md border-green-700 bg-green-500 text-white shadow-md text-2xl font-bold">Summer
      </div>
    </div>


    <!-- Alpine store -->

    <div class="flex justify-center italic">
      <div>The simple BoM List Manager</div>
      <div class="mx-2">
        <a class="text-blue-500 underline" target="_blank" href="https://github.com/vmasdani/summer2">Source</a>
      </div>
    </div>

    <hr class="border-2 my-3" />

    <div class="text-xl">
      Pick your BoM
    </div>

    <!-- <div x-text="JSON.stringify(selectedBom)"></div> -->

    <div class="flex align-center flex-wrap ">
      <button @click="() => { addBom($store) }" class="bg-blue-200 hover:bg-blue-400 px-2 py-1 mr-2"><i
          class="bi bi-plus"></i>
        Add</button>
      <button @click="() => { showList = !showList }"
        :class="`${showList ? 'bg-green-200 hover:bg-green-400' : 'bg-red-200 hover:bg-red-400'}  px-2 py-1 mx-2` ">
        <i :class="`bi bi-${showList ? 'eye' : 'eye-slash' }`"></i> <span
          x-text="`${showList ? 'Hide' : 'Show'} list`"></span>
      </button>
      <button class="bg-gray-200 hover:bg-blue-400 px-2 py-1 mx-2">
        <i class="bi bi-download"></i>
        Download
      </button>
      <button class="bg-gray-200 hover:bg-blue-400 px-2 py-1 mx-2">
        <i class="bi bi-upload"></i>
        Import
      </button>
    </div>


    <template x-if="showList">
      <div>
        <!-- <div class="font-bold" x-text="JSON.stringify($store.idb?.boms)">t</div> -->

        <template x-if="$store.idb?.boms">
          <template x-for="(bom, i) in $store.idb.boms">
            <div class="my-3">
              <div class="flex items-center">
                <div class="flex items-center">
                  <div x-text="i + 1"></div>
                  <button @click="() => { handleDeleteBom($store, bom.id) }"
                    class="bg-red-500 text-white hover:bg-red-600 font-bold px-2 py-1 mx-2 rounded-md"><i
                      class="bi bi-archive-fill"></i></button>
                  <button @click="() => { selectedBom = bom }"
                    :class="`${selectedBom?.id === bom.id ? `bg-gray-500 hover:bg-gray-600` : `bg-blue-500 hover:bg-blue-600`} text-white font-bold px-2 py-1 mx-2 rounded-md`">Select</button>
                </div>

                <div class="flex-grow pl-2">
                  <textarea type="text" :value="bom.name"
                    x-on:blur="(e) => { setBomName($store, bom.id, e.target.value) }"
                    class="focus:outline-none focus:bg-gray-200 border-2 border-gray-400 bg-white shadow-md rounded-md p-2 w-full"
                    placeholder="BOM Name.."></textarea>
                </div>
              </div>
              <!-- <div>TEst</div> -->
              <div class="mt-3">
                <hr class="border-1 border-gray-500" />
              </div>

            </div>
          </template>
        </template>
      </div>
    </template>

    <!-- <div x-text="JSON.stringify(selectedBom)"></div> -->

    <template x-if="selectedBom">
      <div>
        <div>Yoo</div>
        <hr class="border-2 border-gray-500" />

        <div x-text="`Selected BoM: ${selectedBom?.name}`"></div>
      </div>
    </template>
  </div>

</body>

</html>